#!/bin/bash

count=1
quit=0
dir=cd $(dirname $(readlink -f $0))
folder=/sys/class/leds
declare -a folderarray

menu(){
	count=1
	echo "Welcome to the LED Configuration Menu!"
	echo "======================================"
	echo "Please select an LED to configure:"
	for dir in $(ls $folder);
	do 
		echo $count. $dir
		folderarray[$count]=$dir
		let count++
	done
	echo $count. "Quit"
}

submenu(){
	subquit=0
	while [ $subquit -eq 0 ]; do
		echo ${PWD##*/}
		echo "======================================"
		echo "What would you like to do with this LED?"
		echo "1) turn on"
		echo "2) turn off"
		echo "3) associate with a system event"
		echo "4) associate with the performance of a process"
		echo "5) stop association with a process' performance"
		echo "6) quit to main menu"
		echo "Please enter a number (1-6) for your choice: "	
		read choice
		echo
		case $choice in
			1)
				echo 1 | sudo tee brightness >/dev/null
				echo ${PWD##*/} "turned on."
				echo
				;;
			2)
				echo 0 | sudo tee brightness >/dev/null
				echo ${PWD##*/} "turned off."
				echo
				;;
			3)
				syseventmenu
				echo
				;;
			4)
				processmenu
				#dirname "$(readlink -f "$0")"
				#cd $0
				#source ./led_monitor
				;;
			5)
				kill ./led_monitor
				;;
			6)
				subquit=1
				;;
			?)
				echo "Invalid option entered. Please enter again."
				echo ""
				;;
		esac
	done
}

syseventmenu(){
	count=1
	for trigger in $(cat trigger);
	do 
		echo $count. $trigger
		syseventarray[$count]=$trigger
		let count++
	done
	echo $count. "Quit"
	read choice
	echo
	if ((1<=$choice && $choice<=$count-1))
		then
		echo ${syseventarray[$choice]} | sudo tee trigger >/dev/null
	elif [ $choice -eq $count ]
		then
		syseventquit=1
	else
		echo "Invalid option entered. Please enter again."
		echo
	fi
}

processmenu(){
	echo "Associate LED with the performance of a process"
	echo "-----------------------------------------------"
	echo "Please enter the name of the program to monitor"
	echo "(partial names are ok):"
	read program
	for prog in $(ps | awk '{ print $4 }' | sed 1,1d); do
		if (($prog == $program))
			then
			echo $prog
		fi
	done
}


#Script Entry Point is here
while [ $quit -eq 0 ]; do
	menu
	read choice
	echo
	if ((1<=$choice && $choice<=$count-1))
		then
		cd $folder
		cd ${folderarray[$choice]}
		submenu
	elif [ $choice -eq $count ]
		then
		quit=1
	else
		echo "Invalid option entered. Please enter again."
		echo
	fi
done
echo "Goodbye!"
